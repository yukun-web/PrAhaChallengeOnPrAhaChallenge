@startuml
' プラハチャレンジ ドメインモデル図（境界づけられたコンテキスト反映）
skinparam class {
  BackgroundColor White
  BorderColor #888
}
skinparam package {
  BackgroundColor #F9F9F9
  BorderColor #666
}
skinparam shadowing false
hide circle

' 境界づけられたコンテキストの定義（パッケージ）
package "参加者コンテキスト" as BC_Participant <<Bounded Context>> {
  class 参加者 {
    +ID: UUID
    +名前: string
    +メールアドレス: string
    +在籍ステータス: 在籍ステータス
    --
    {static} +入会(名前, メールアドレス): 参加者
    +休会(): 参加者
    +復帰(): 参加者
    +退会(): 参加者
    -- 制約 --
    メールアドレスは一意
  }

  enum 在籍ステータス {
    在籍中
    休会中
    退会済
  }

  together {
    class 入会イベント <<Event>> {
      +参加者ID: UUID
      +名前: string
      +入会日時: Date
    }

    class 休会イベント <<Event>> {
      +参加者ID: UUID
      +名前: string
      +休会日時: Date
    }

    class 復帰イベント <<Event>> {
      +参加者ID: UUID
      +名前: string
      +復帰日時: Date
    }

    class 退会イベント <<Event>> {
      +参加者ID: UUID
      +名前: string
      +退会日時: Date
    }
  }
}

package "チームコンテキスト" as BC_Team <<Bounded Context>> {
  class チーム {
    +ID: UUID
    +名前: string
    +メンバー数: int
    --
    {static} +新規作成(名前, チームメンバー[]): チーム
    +追加(チームメンバー): チーム
    +除外(チームメンバー): チーム
    -- 制約 --
    名前は英字のみ（例: a, b, c, ...）
    チーム名は一意
    人数は原則 2..4 名（一時的に 1 や 5 もあり得る）
  }

  class チームメンバー {
    +ID: UUID
    +参加者ID: UUID
    +名前: string
    --
    {static} +作成(参加者ID, 名前): チームメンバー
  }

  class チーム再編成サービス {
    +チームにメンバーを追加(チームメンバー): チーム
    +チームメンバーを外す(参加者ID): チーム
    -最小人数チームを探す(): チーム
  }

  class チームリポジトリ {
    +チームを保存(チーム): void
    +チームを削除(チームID): void
    +チームを取得(チームID): チーム
    +最小人数チームを取得(): チーム[]
  }

  class 消滅危機チーム発生イベント <<Event>> {
    +チームID: UUID
    +チーム名: string
    +発生日時: Date
  }

  class 要合流チーム発生イベント <<Event>> {
    +チームID: UUID
    +チーム名: string
    +発生日時: Date
  }

  class 要分割チーム発生イベント <<Event>> {
    +チームID: UUID
    +チーム名: string
    +発生日時: Date
  }

  note as N_TeamRules
    自動再編成ルール:
    - 減少で 2 名以下になった場合: 管理者に通知
    - 1 名チームが発生: 最少人数のチームへ自動合流（同数はランダム）
    - 復帰（休会/退会から在籍中へ）: 最少人数のチームに自動所属
    - 5 名になった場合: 自動的に 2 チームに分解（分け方は任意）
  end note

  チーム o-- "*" チームメンバー : メンバーリスト
  チーム再編成サービス .left.> チームリポジトリ : 依存
  チーム .right.> チームリポジトリ : 永続化
  チーム再編成サービス ..> 消滅危機チーム発生イベント : 発行
  チーム再編成サービス ..> 要合流チーム発生イベント : 発行
  チーム再編成サービス ..> 要分割チーム発生イベント : 発行
}

package "課題コンテキスト" as BC_Task <<Bounded Context>> {
  class 課題 {
    +ID: UUID
    +タイトル: string
  }

  ' 参加者ごとの課題進捗（割当）
  class 課題割り当て {
    +ID: UUID
    +課題ID: UUID
    +参加者ID: UUID
    +進捗ステータス: 進捗ステータス
    --
    {static} +割当(課題ID, 参加者ID): 参加者課題
    +着手(): 参加者課題
    +レビュー依頼(): 参加者課題
    +レビュー依頼を取り消し(): 参加者課題
    +完了(): 参加者課題
  }

  enum 進捗ステータス {
    未着手
    取組中
    レビュー待ち
    完了
  }

  note right of 課題割り当て
    進捗ステータス遷移:
    未着手 -> 取組中 -> レビュー待ち -> 完了
    レビュー待ち -> 取組中 への戻し可
    完了 は変更不可
    進捗を変更できるのは所有者の 参加者 のみ
  end note

  ' コンテキスト内の関連
  課題   "1" -- "*" 課題割り当て : 課題ID
}

@enduml