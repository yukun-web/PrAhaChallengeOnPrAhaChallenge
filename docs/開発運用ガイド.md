# 開発運用ガイド

このドキュメントでは、GitHub Issue/Project を使った開発運用ルールを説明します。

---

## 1. Issue 管理

### 1.1 ラベル一覧

#### ステータス

| ラベル | 説明 | 色 |
|--------|------|-----|
| `status/backlog` | ざっくり洗い出した段階 | #d4c5f9 (薄紫) |
| `status/ready` | 詳細設計完了、着手可能 | #0e8a16 (緑) |
| `status/in-progress` | 作業中 | #fbca04 (黄) |

#### ドメイン

| ラベル | 説明 | 色 |
|--------|------|-----|
| `domain/participant` | 参加者ドメイン | #1d76db (青) |
| `domain/team` | チームドメイン | #5319e7 (紫) |
| `domain/task` | 課題ドメイン | #d93f0b (オレンジ) |

#### タイプ

| ラベル | 説明 | 色 |
|--------|------|-----|
| `type/feature` | 新機能 | #a2eeef (水色) |
| `type/refactor` | リファクタリング | #fef2c0 (ベージュ) |

#### サイズ

| ラベル | 説明 |
|--------|------|
| `size/S` | 小規模（1-2h） |
| `size/M` | 中規模（半日） |
| `size/L` | 大規模（1日以上） |

#### ストリーム

| ラベル | 説明 | 色 |
|--------|------|-----|
| `stream/team-domain` | チームドメイン開発 | #6f42c1 (紫) |
| `stream/task-domain` | 課題ドメイン開発 | #d93f0b (オレンジ) |
| `stream/notification` | 通知基盤 | #0366d6 (青) |
| `stream/integration` | 統合・結合 | #28a745 (緑) |
| `stream/frontend` | フロントエンド | #e36209 (茶) |

#### 並行可否

| ラベル | 説明 | 色 |
|--------|------|-----|
| `parallel/ok` | 他 Issue と並行着手可能 | #2cbe4e (明緑) |
| `parallel/blocked` | 依存 Issue の完了待ち | #cb2431 (赤) |

### 1.2 Issue ワークフロー

```
[新規作成] → status/backlog
     ↓
[詳細設計完了] → status/ready（テンプレート更新）
     ↓
[着手] → status/in-progress（ブランチ作成）
     ↓
[PR作成] → レビュー
     ↓
[マージ] → Issue クローズ
```

### 1.3 依存関係の記載方法

Issue 本文の冒頭に以下の形式で記載します：

```markdown
## 依存関係
Blocked by #1, #2
```

GitHub Actions により、依存 Issue がクローズされると自動的に `parallel/blocked` → `parallel/ok` に変更されます。

---

## 2. ブランチ管理

### 2.1 命名規則

```
feature/{issue番号}-{短い説明}
```

例：
- `feature/1-team-vo`
- `feature/12-notification`
- `feature/23-team-list`

### 2.2 ストリーム別ブランチ戦略

#### 独立ストリーム（team-domain, task-domain, notification）

- main から直接ブランチを切る
- ストリーム内の依存がある場合は親ブランチから派生

```
main
 ├── feature/1-team-vo
 │    └── feature/2-team-entity
 │         ├── feature/3-team-name-validation
 │         └── feature/4-team-name-duplicate-check
 │
 ├── feature/17-task-vo
 │    └── feature/18-task-entity
 │
 └── feature/12-notification
```

#### 統合ストリーム（integration）

- 独立ストリームが main にマージされた後に開始
- main から直接ブランチを切る

### 2.3 ブランチ運用ルール

1. **ストリーム内の依存ブランチ**:
   - 親ブランチからブランチを切る
   - PR は親ブランチ向けに作成
   - 親がマージされたら rebase して main 向けに変更

2. **独立ブランチ**:
   - 依存がない場合は main から直接ブランチを切る

3. **コンフリクト対策**:
   - 異なるストリーム間はファイル競合が少ない設計
   - 競合発生時は先にマージされたブランチを rebase

---

## 3. 並行開発

### 3.1 ストリーム一覧

| ストリーム | 説明 | 独立性 |
|-----------|------|--------|
| team-domain | チームエンティティ・リポジトリ | ✅ 独立 |
| task-domain | 課題エンティティ・リポジトリ | ✅ 独立 |
| notification | メール送信サービス | ✅ 独立 |
| integration | ドメイン間の統合処理 | ⏳ 上記完了後 |
| frontend | UI 実装 | ⏳ ドメイン完了後 |

### 3.2 依存関係グラフ

```
Stream A: team-domain        Stream B: task-domain        Stream C: notification
─────────────────────        ─────────────────────        ───────────────────
#1 TeamId/TeamName VO        #17 TaskId/TaskStatus VO     #12 メール送信サービス
       ↓                            ↓
#2 Team エンティティ           #18 Task エンティティ
   ├─→ #3 英文字バリデ            ├─→ #19 ステータス遷移
   ├─→ #4 重複チェック            ├─→ #20 所有者制約
   └─→ #5 Repository IF           └─→ #21 Repository IF
          ↓                              ↓
       #6 Drizzle実装              #22 Drizzle実装

─────────────────────────────────────────────────────────────────
                        ↓ マージ後 ↓
─────────────────────────────────────────────────────────────────

Stream D: integration（チーム×参加者）
──────────────────────────────
#7 Participant: TeamId追加  ←── Stream A 完了後
       ↓
#8 Team: join/leave
   ├─→ #9 人数制約
   └─→ #10 ステータス整合性
          ↓
#11 最少人数チーム検索
          ↓
   ┌──────┼──────┐
   ↓      ↓      ↓
#15    #14    #16
復帰   合流   分割  ←── #12 (Stream C) 必要
```

### 3.3 推奨：3並列開発プラン

**初期フェーズ（3 worktree 同時稼働）**:

| Worktree | 担当ストリーム | 着手 Issue |
|----------|---------------|------------|
| worktree-1 | team-domain | #1 → #2 → #3,#4,#5 → #6 |
| worktree-2 | task-domain | #17 → #18 → #19,#20,#21 → #22 |
| worktree-3 | notification | #12 |

**統合フェーズ（Stream A,B,C 完了後）**:

| Worktree | 担当ストリーム | 着手 Issue |
|----------|---------------|------------|
| worktree-1 | integration | #7 → #8 → #9,#10 → #11 |
| worktree-2 | integration | #14, #15, #16（#11 完了後） |
| worktree-3 | frontend | #23 → #24, #25 → #26 |

### 3.4 worktree の使い方

```bash
# 新規 worktree 作成（自動採番）
pnpm worktree:new
# → PrAhaChallengeOnPrAhaChallenge_worktree_1 が作成される

# worktree 内で作業用ブランチを作成
cd ../PrAhaChallengeOnPrAhaChallenge_worktree_1
git checkout -b feature/1-team-vo

# 完了後（worktree 内で実行）
pnpm worktree:close
```

---

## 4. PR ルール

### 4.1 必須条件

- `pnpm test` - 全テスト通過
- `pnpm lint` - lint エラーなし
- `pnpm build` - ビルド成功
- レビュー承認

### 4.2 PR 作成時

- Issue 番号をリンク（`Closes #N`）
- 変更内容の概要を記載
- テスト方法を記載

---

## 5. GitHub Projects 設定

### 5.1 カラム構成

| カラム | 説明 | 自動化トリガー |
|--------|------|----------------|
| Backlog | ざっくり洗い出した Issue | Issue 作成時 |
| Ready | 詳細設計完了、着手可能 | `status/ready` ラベル付与時 |
| In Progress | 作業中 | `status/in-progress` ラベル付与時 |
| In Review | PR レビュー中 | PR がリンクされた時 |
| Done | 完了 | Issue クローズ時 |

### 5.2 ビュー設定

- **Board ビュー**: カンバン形式でステータス管理
- **Table ビュー**: ドメイン/サイズでフィルタ・ソート
- **Ready ビュー**: `parallel/ok` フィルタで着手可能 Issue のみ表示
